#!/bin/sh

# Pre-push hook: verify Android build before pushing
# Bypass with: git push --no-verify

# Get list of files being pushed
CHANGED_FILES=$(git diff --name-only HEAD@{1}..HEAD 2>/dev/null || git diff --name-only HEAD~1..HEAD 2>/dev/null || echo "")

# Check if any client or packages files changed
CLIENT_CHANGED=$(echo "$CHANGED_FILES" | grep -E "^(apps/client/|packages/)" || true)

if [ -z "$CLIENT_CHANGED" ]; then
    echo "‚è≠Ô∏è  No client/packages changes detected, skipping build verification."
    exit 0
fi

echo "üîç Client changes detected, running full Android build verification..."
echo ""

# Step 1: Build web assets
echo "üèóÔ∏è  [1/3] Building web assets..."
pnpm --filter client build
if [ $? -ne 0 ]; then
    echo "‚ùå WEB BUILD FAILED! Push blocked."
    echo "To bypass: git push --no-verify"
    exit 1
fi
echo "‚úÖ Web assets OK"

# Step 2: Cap sync
echo "üîÑ [2/3] Syncing to Android..."
cd apps/client
npx cap sync android
if [ $? -ne 0 ]; then
    echo "‚ùå CAP SYNC FAILED! Push blocked."
    echo "To bypass: git push --no-verify"
    exit 1
fi
echo "‚úÖ Cap sync OK"

# Step 3: Gradle build (debug, no signing needed)
echo "ü§ñ [3/3] Building Android native..."
cd android
chmod +x gradlew 2>/dev/null
./gradlew assembleDebug
if [ $? -ne 0 ]; then
    echo "‚ùå GRADLE BUILD FAILED! Push blocked."
    echo "To bypass: git push --no-verify"
    exit 1
fi

echo ""
echo "‚úÖ Full Android build verification passed. Pushing..."
