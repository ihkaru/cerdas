services:
  # ==========================================
  # BACKEND (Laravel API)
  # ==========================================
  backend:
    build:
      context: ./apps/backend
      dockerfile: Dockerfile.prod
    restart: always
    expose:
      - "80"
    environment:
      - APP_ENV=production
      - APP_DEBUG=false
      - APP_KEY=${APP_KEY}
      - APP_URL=${APP_URL}
      - DB_CONNECTION=mysql
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT}
      - DB_DATABASE=${DB_DATABASE}
      - DB_USERNAME=${DB_USERNAME}
      - DB_PASSWORD=${DB_PASSWORD}
      - SANCTUM_STATEFUL_DOMAINS=${SANCTUM_STATEFUL_DOMAINS}
      - SESSION_DOMAIN=${SESSION_DOMAIN}
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS}
    healthcheck:
      test: ["CMD", "php", "artisan", "optimize:clear"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ==========================================
  # CLIENT (Mobile PWA)
  # ==========================================
  client:
    build:
      context: ./apps/client
      dockerfile: Dockerfile.prod
      args:
        VITE_API_BASE_URL: ${VITE_API_BASE_URL}
    restart: always
    expose:
      - "80"
    environment:
      - VITE_API_BASE_URL=${VITE_API_BASE_URL}

  # ==========================================
  # EDITOR (Web Dashboard)
  # ==========================================
  editor:
    build:
      context: ./apps/editor
      dockerfile: Dockerfile.prod
      args:
        VITE_API_BASE_URL: ${VITE_API_BASE_URL}
    restart: always
    expose:
      - "80"
    environment:
      - VITE_API_BASE_URL=${VITE_API_BASE_URL}

  # ==========================================
  # WORKER (Queue)
  # ==========================================
  worker:
    build:
      context: ./apps/backend
      dockerfile: Dockerfile.prod
    restart: always
    command: php artisan queue:work --tries=3 --timeout=90
    environment:
      - APP_ENV=production
      - DB_CONNECTION=mysql
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT}
      - DB_DATABASE=${DB_DATABASE}
      - DB_USERNAME=${DB_USERNAME}
      - DB_PASSWORD=${DB_PASSWORD}
    depends_on:
      - backend

  # ==========================================
  # SCHEDULER (Cron)
  # ==========================================
  scheduler:
    build:
      context: ./apps/backend
      dockerfile: Dockerfile.prod
    restart: always
    command: php artisan schedule:work
    environment:
      - APP_ENV=production
      - DB_CONNECTION=mysql
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT}
      - DB_DATABASE=${DB_DATABASE}
      - DB_USERNAME=${DB_USERNAME}
      - DB_PASSWORD=${DB_PASSWORD}
    depends_on:
      - backend
