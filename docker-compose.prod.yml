services:
  # ==========================================
  # BACKEND (Laravel API)
  # ==========================================
  backend:
    build:
      context: ./apps/backend
      dockerfile: Dockerfile.prod
    restart: always
    expose:
      - "8080"
    environment:
      - APP_ENV=production
      - APP_DEBUG=false
      - APP_KEY=${APP_KEY}
      - APP_URL=${APP_URL}
      - DB_CONNECTION=mysql
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT}
      - DB_DATABASE=${DB_DATABASE}
      - DB_USERNAME=${DB_USERNAME}
      - DB_PASSWORD=${DB_PASSWORD}
      - SANCTUM_STATEFUL_DOMAINS=${SANCTUM_STATEFUL_DOMAINS}
      - SESSION_DOMAIN=${SESSION_DOMAIN}
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS}
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - VITE_GOOGLE_CLIENT_ID=${VITE_GOOGLE_CLIENT_ID}
      # Performance optimizations
      - PHP_OPCACHE_ENABLE=1
      - OCTANE_SERVER=frankenphp
      - OCTANE_FRANKENPHP_BINARY=/usr/local/bin/frankenphp
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/up"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - coolify
      - default

  # ==========================================
  # CLIENT (Mobile PWA)
  # ==========================================
  client:
    build:
      context: .
      dockerfile: apps/client/Dockerfile.prod
      args:
        VITE_API_BASE_URL: ${VITE_API_BASE_URL}
        VITE_GOOGLE_CLIENT_ID: ${VITE_GOOGLE_CLIENT_ID}
    restart: always
    expose:
      - "80"
    environment:
      - VITE_API_BASE_URL=${VITE_API_BASE_URL}
      - VITE_GOOGLE_CLIENT_ID=${VITE_GOOGLE_CLIENT_ID}
    networks:
      - coolify
      - default

  # ==========================================
  # EDITOR (Web Dashboard)
  # ==========================================
  editor:
    build:
      context: .
      dockerfile: apps/editor/Dockerfile.prod
      args:
        VITE_API_BASE_URL: ${VITE_API_BASE_URL}
        VITE_GOOGLE_CLIENT_ID: ${VITE_GOOGLE_CLIENT_ID}
    restart: always
    expose:
      - "80"
    environment:
      - VITE_API_BASE_URL=${VITE_API_BASE_URL}
      - VITE_GOOGLE_CLIENT_ID=${VITE_GOOGLE_CLIENT_ID}
    networks:
      - coolify
      - default

  # ==========================================
  # WORKER (Queue)
  # ==========================================
  worker:
    build:
      context: ./apps/backend
      dockerfile: Dockerfile.prod
    restart: always
    entrypoint: ["php"]
    command: ["artisan", "queue:work", "--tries=3", "--timeout=90"]
    environment:
      - APP_ENV=production
      - APP_KEY=${APP_KEY}
      - APP_URL=${APP_URL}
      - DB_CONNECTION=mysql
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT}
      - DB_DATABASE=${DB_DATABASE}
      - DB_USERNAME=${DB_USERNAME}
      - DB_PASSWORD=${DB_PASSWORD}
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - PHP_OPCACHE_ENABLE=1
    depends_on:
      - backend
    networks:
      - coolify
      - default

  # ==========================================
  # SCHEDULER (Cron)
  # ==========================================
  scheduler:
    build:
      context: ./apps/backend
      dockerfile: Dockerfile.prod
    restart: always
    entrypoint: ["php"]
    command: ["artisan", "schedule:work"]
    environment:
      - APP_ENV=production
      - APP_KEY=${APP_KEY}
      - APP_URL=${APP_URL}
      - DB_CONNECTION=mysql
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT}
      - DB_DATABASE=${DB_DATABASE}
      - DB_USERNAME=${DB_USERNAME}
      - DB_PASSWORD=${DB_PASSWORD}
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - PHP_OPCACHE_ENABLE=1
    depends_on:
      - backend
    networks:
      - coolify
      - default

networks:
  coolify:
    external: true
