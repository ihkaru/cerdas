name: Secret Leak Detection

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  scan:
    runs-on: ubuntu-latest
    name: Scan for leaked secrets
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Scan for hardcoded secrets
        run: |
          echo "ğŸ” Secret Leak Detection"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          ISSUES=0

          # Pattern: Private keys
          HITS=$(grep -rn "PRIVATE KEY" --include="*.php" --include="*.ts" --include="*.js" --include="*.vue" --include="*.json" --include="*.yml" --include="*.yaml" --include="*.env*" --include="*.md" . 2>/dev/null | grep -v node_modules | grep -v vendor | grep -v ".git/" || true)
          if [ -n "$HITS" ]; then
            echo "ğŸ”´ [CRITICAL] Private key found:"
            echo "$HITS"
            ISSUES=$((ISSUES + 1))
          fi

          # Pattern: AWS keys
          HITS=$(grep -rn "AKIA[0-9A-Z]\{16\}" . --include="*.php" --include="*.ts" --include="*.js" --include="*.vue" --include="*.json" --include="*.yml" --include="*.env*" 2>/dev/null | grep -v node_modules | grep -v vendor | grep -v ".git/" || true)
          if [ -n "$HITS" ]; then
            echo "ğŸ”´ [CRITICAL] AWS Access Key found:"
            echo "$HITS"
            ISSUES=$((ISSUES + 1))
          fi

          # Pattern: Generic secrets/passwords in code (not .env.example)
          HITS=$(grep -rn 'password\s*=\s*["\x27][^"\x27]\{8,\}' . --include="*.php" --include="*.ts" --include="*.js" --include="*.vue" 2>/dev/null | grep -v node_modules | grep -v vendor | grep -v ".git/" | grep -v "test" | grep -v "factory" | grep -v "migration" | grep -v "example" | grep -v "validation" | grep -vi "hash\|bcrypt\|reset\|confirm\|rules\|request\|validate\|field\|input\|label\|placeholder" || true)
          if [ -n "$HITS" ]; then
            echo "ğŸŸ¡ [WARNING] Possible hardcoded password:"
            echo "$HITS"
          fi

          # Pattern: API keys/tokens in code
          HITS=$(grep -rn 'api[_-]\?\(key\|token\|secret\)\s*=\s*["\x27][a-zA-Z0-9]\{20,\}' . --include="*.php" --include="*.ts" --include="*.js" --include="*.vue" 2>/dev/null | grep -v node_modules | grep -v vendor | grep -v ".git/" | grep -v ".example" || true)
          if [ -n "$HITS" ]; then
            echo "ğŸ”´ [CRITICAL] API key/token found:"
            echo "$HITS"
            ISSUES=$((ISSUES + 1))
          fi

          # Pattern: Database connection strings with password
          HITS=$(grep -rn 'mysql://.\+:.\+@' . --include="*.php" --include="*.ts" --include="*.js" --include="*.yml" --include="*.env" 2>/dev/null | grep -v node_modules | grep -v vendor | grep -v ".git/" | grep -v ".example" || true)
          if [ -n "$HITS" ]; then
            echo "ğŸ”´ [CRITICAL] Database connection string with credentials:"
            echo "$HITS"
            ISSUES=$((ISSUES + 1))
          fi

          # Pattern: .env files committed (not .example)
          HITS=$(find . -name ".env" -o -name ".env.local" -o -name ".env.production" | grep -v node_modules | grep -v vendor | grep -v ".git/" || true)
          if [ -n "$HITS" ]; then
            echo "ğŸŸ¡ [WARNING] .env file(s) in repo (check .gitignore):"
            echo "$HITS"
          fi

          # Pattern: Keystore/certificate files
          HITS=$(find . -name "*.jks" -o -name "*.keystore" -o -name "*.p12" -o -name "*.pem" -o -name "*.pfx" | grep -v node_modules | grep -v vendor | grep -v ".git/" || true)
          if [ -n "$HITS" ]; then
            echo "ğŸ”´ [CRITICAL] Certificate/keystore file in repo:"
            echo "$HITS"
            ISSUES=$((ISSUES + 1))
          fi

          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          if [ $ISSUES -gt 0 ]; then
            echo "âŒ Found $ISSUES CRITICAL secret leak(s)! Fix immediately."
            echo ""
            echo "To remove from git history, run:"
            echo "  ./scripts/remove-secret-from-history.ps1 -FilePath <leaked-file>"
            exit 1
          fi

          echo "âœ… No secret leaks detected."
